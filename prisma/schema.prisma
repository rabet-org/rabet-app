// Rabet Platform - Prisma Schema
// Generated from docs/ERD.md
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─────────────────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────────────────

enum UserRole {
  client
  provider
  admin
}

enum AuthProvider {
  local
  google
  facebook
  apple
}

enum ProviderType {
  agency
}

enum ApplicationStatus {
  pending
  approved
  rejected
}

enum TransactionType {
  deposit
  debit
  refund
  adjustment
}

enum RequestStatus {
  draft
  published
  in_progress
  completed
  cancelled
}

enum UnlockStatus {
  pending
  completed
  failed
  refunded
}

enum PlanType {
  free
  basic
  premium
}

enum BillingCycle {
  monthly
  annual
}

enum SubscriptionStatus {
  active
  expired
  cancelled
}

enum SubscriptionEventType {
  created
  renewed
  upgraded
  downgraded
  cancelled
}

enum NotificationType {
  email_verified
  application_approved
  application_rejected
  request_unlocked
  low_wallet_balance
  subscription_renewed
  subscription_expiring
  new_review_received
  request_status_changed
  refund_processed
  admin_message
}

enum AdminActionType {
  approve_provider
  reject_provider
  verify_provider
  unverify_provider
  moderate_request
  remove_review
  process_refund
  block_user
  unblock_user
  adjust_wallet
  create_admin
  remove_admin
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed
}

enum TicketPriority {
  low
  medium
  high
}

// ─────────────────────────────────────────────────────────
// 1. USER
// Core identity and status.
// ─────────────────────────────────────────────────────────

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  role              UserRole  @default(client)
  email_verified    Boolean   @default(false)
  email_verified_at DateTime?
  is_active         Boolean   @default(true)
  is_blocked        Boolean   @default(false)
  last_login_at     DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relations
  auth                  UserAuth?
  profile               UserProfile?
  refresh_tokens        RefreshToken[]
  provider_application  ProviderApplication?  @relation("UserApplication")
  provider_profile      ProviderProfile?      @relation("UserProviderProfile")
  requests              Request[]
  reviews               Review[]              @relation("ClientReviews")
  notifications         Notification[]
  admin_logs            AdminLog[]            @relation("AdminActions")
  reviewed_applications ProviderApplication[] @relation("ReviewedByAdmin")
  verified_profiles     ProviderProfile[]     @relation("VerifiedByAdmin")
  support_tickets       SupportTicket[]       @relation("UserTickets")
  assigned_tickets      SupportTicket[]       @relation("AssignedTickets")
  ticket_replies        TicketReply[]
  settings_updates      PlatformSetting[]
  broadcast_messages    BroadcastMessage[]

  @@map("users")
}

// ─────────────────────────────────────────────────────────
// 2. USER_AUTH
// Sensitive authentication state — credentials & tokens.
// ─────────────────────────────────────────────────────────

model UserAuth {
  id                               String       @id @default(uuid())
  user_id                          String       @unique
  password_hash                    String?
  auth_provider                    AuthProvider @default(local)
  oauth_id                         String?
  email_verification_token         String?
  email_verification_token_expires DateTime?
  password_reset_token             String?
  password_reset_expires           DateTime?
  created_at                       DateTime     @default(now())
  updated_at                       DateTime     @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([oauth_id, auth_provider])
  @@index([email_verification_token])
  @@index([password_reset_token])
  @@map("user_auth")
}

// ─────────────────────────────────────────────────────────
// 3. USER_PROFILE
// Display and contact information.
// ─────────────────────────────────────────────────────────

model UserProfile {
  id         String   @id @default(uuid())
  user_id    String   @unique
  full_name  String
  phone      String?
  avatar_url String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ─────────────────────────────────────────────────────────
// 4. REFRESH_TOKEN
// JWT refresh token storage for multi-session support.
// ─────────────────────────────────────────────────────────

model RefreshToken {
  id          String    @id @default(uuid())
  user_id     String
  token_hash  String    @unique
  device_info String?
  ip_address  String?
  expires_at  DateTime
  revoked     Boolean   @default(false)
  revoked_at  DateTime?
  created_at  DateTime  @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([expires_at])
  @@map("refresh_tokens")
}

// ─────────────────────────────────────────────────────────
// 5. CATEGORY
// Normalized lookup table for service categories.
// ─────────────────────────────────────────────────────────

model Category {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?
  icon        String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())

  // Relations
  requests          Request[]
  provider_services ProviderService[]

  @@index([is_active])
  @@map("categories")
}

// ─────────────────────────────────────────────────────────
// 6. PROVIDER_APPLICATION
// Applications submitted by clients to become providers.
// ─────────────────────────────────────────────────────────

model ProviderApplication {
  id                 String            @id @default(uuid())
  user_id            String            @unique
  provider_type      ProviderType
  business_name      String?
  description        String
  portfolio_url      String?
  verification_docs  Json
  application_status ApplicationStatus @default(pending)
  rejection_reason   String?
  reviewed_by        String?
  reviewed_at        DateTime?
  created_at         DateTime          @default(now())
  updated_at         DateTime          @updatedAt

  // Relations
  user             User             @relation("UserApplication", fields: [user_id], references: [id], onDelete: Cascade)
  reviewer         User?            @relation("ReviewedByAdmin", fields: [reviewed_by], references: [id])
  provider_profile ProviderProfile?

  @@index([application_status])
  @@map("provider_applications")
}

// ─────────────────────────────────────────────────────────
// 7. PROVIDER_PROFILE
// Approved provider public profile.
// ─────────────────────────────────────────────────────────

model ProviderProfile {
  id             String    @id @default(uuid())
  user_id        String    @unique
  application_id String    @unique
  description    String?
  portfolio_url  String?
  is_verified    Boolean   @default(false)
  verified_at    DateTime?
  verified_by    String?
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  // Relations
  user                 User                  @relation("UserProviderProfile", fields: [user_id], references: [id], onDelete: Cascade)
  application          ProviderApplication   @relation(fields: [application_id], references: [id])
  verifier             User?                 @relation("VerifiedByAdmin", fields: [verified_by], references: [id])
  services             ProviderService[]
  wallet               ProviderWallet?
  unlocks              LeadUnlock[]
  reviews              Review[]              @relation("ProviderReviews")
  subscription         Subscription?
  subscription_history SubscriptionHistory[]

  @@index([is_verified])
  @@map("provider_profiles")
}

// ─────────────────────────────────────────────────────────
// 8. PROVIDER_SERVICE
// Join table: provider ↔ category (many-to-many).
// ─────────────────────────────────────────────────────────

model ProviderService {
  provider_id String
  category_id String
  created_at  DateTime @default(now())

  // Relations
  provider ProviderProfile @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  category Category        @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@id([provider_id, category_id])
  @@index([category_id])
  @@map("provider_services")
}

// ─────────────────────────────────────────────────────────
// 9. PROVIDER_WALLET
// Provider's walletbalance. Aggregates computed on demand.
// ─────────────────────────────────────────────────────────

model ProviderWallet {
  id          String   @id @default(uuid())
  provider_id String   @unique
  balance     Decimal  @default(0) @db.Decimal(12, 2)
  currency    String   @default("EGP")
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  provider     ProviderProfile     @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@map("provider_wallets")
}

// ─────────────────────────────────────────────────────────
// 10. WALLET_TRANSACTION
// Immutable audit log of all wallet operations.
// ─────────────────────────────────────────────────────────

model WalletTransaction {
  id             String          @id @default(uuid())
  wallet_id      String
  provider_id    String
  type           TransactionType
  amount         Decimal         @db.Decimal(12, 2)
  balance_before Decimal         @db.Decimal(12, 2)
  balance_after  Decimal         @db.Decimal(12, 2)
  reference_type String?
  reference_id   String?
  description    String?
  metadata       Json?
  created_at     DateTime        @default(now())

  // Relations
  wallet               ProviderWallet       @relation(fields: [wallet_id], references: [id])
  lead_unlock          LeadUnlock?
  subscription_history SubscriptionHistory?

  @@index([wallet_id, created_at])
  @@index([provider_id, created_at])
  @@index([reference_type, reference_id])
  @@map("wallet_transactions")
}

// ─────────────────────────────────────────────────────────
// 11. REQUEST
// Service requests posted by clients.
// ─────────────────────────────────────────────────────────

model Request {
  id                 String        @id @default(uuid())
  user_id            String
  category_id        String
  title              String
  description        String
  budget_range       String?
  location           String?
  status             RequestStatus @default(draft)
  deadline           DateTime?
  unlock_fee         Decimal       @default(50.00) @db.Decimal(12, 2)
  project_duration   String?
  experience_level   String?
  skills_required    String[]      @default([])
  preferred_language String?       @default("arabic")
  is_urgent          Boolean       @default(false)
  attachments        String[]      @default([])
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt

  // Relations
  user     User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  category Category     @relation(fields: [category_id], references: [id])
  unlocks  LeadUnlock[]
  reviews  Review[]

  @@index([user_id])
  @@index([category_id])
  @@index([status])
  @@index([status, category_id])
  @@map("requests")
}

// ─────────────────────────────────────────────────────────
// 12. LEAD_UNLOCK
// Tracks which providers paid to unlock a request.
// ─────────────────────────────────────────────────────────

model LeadUnlock {
  id                    String       @id @default(uuid())
  request_id            String
  provider_id           String
  wallet_transaction_id String       @unique
  unlock_fee            Decimal      @db.Decimal(12, 2)
  status                UnlockStatus
  failed_reason         String?
  refunded_at           DateTime?
  unlocked_at           DateTime     @default(now())
  completed_at          DateTime?

  // Relations
  request            Request           @relation(fields: [request_id], references: [id])
  provider           ProviderProfile   @relation(fields: [provider_id], references: [id])
  wallet_transaction WalletTransaction @relation(fields: [wallet_transaction_id], references: [id])

  @@unique([request_id, provider_id])
  @@index([provider_id, status])
  @@map("lead_unlocks")
}

// ─────────────────────────────────────────────────────────
// 13. REVIEW
// Client ratings for providers. Soft-delete pattern.
// ─────────────────────────────────────────────────────────

model Review {
  id          String    @id @default(uuid())
  request_id  String
  client_id   String
  provider_id String
  rating      Int
  comment     String?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  deleted_at  DateTime?

  // Relations
  request  Request         @relation(fields: [request_id], references: [id])
  client   User            @relation("ClientReviews", fields: [client_id], references: [id])
  provider ProviderProfile @relation("ProviderReviews", fields: [provider_id], references: [id])

  @@unique([request_id, client_id, provider_id])
  @@map("reviews")
}

// ─────────────────────────────────────────────────────────
// 14. SUBSCRIPTION
// Optional plan for providers — free unlocks + priority.
// ─────────────────────────────────────────────────────────

model Subscription {
  id                     String             @id @default(uuid())
  provider_id            String             @unique
  plan_type              PlanType
  free_unlocks_remaining Int                @default(0)
  priority_listing       Boolean            @default(false)
  billing_cycle          BillingCycle       @default(monthly)
  starts_at              DateTime
  expires_at             DateTime
  status                 SubscriptionStatus
  cancelled_at           DateTime?
  created_at             DateTime           @default(now())
  updated_at             DateTime           @updatedAt

  // Relations
  provider ProviderProfile       @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  history  SubscriptionHistory[]

  @@index([status, expires_at])
  @@map("subscriptions")
}

// ─────────────────────────────────────────────────────────
// 15. SUBSCRIPTION_HISTORY
// Immutable billing event log per subscription.
// ─────────────────────────────────────────────────────────

model SubscriptionHistory {
  id                    String                @id @default(uuid())
  subscription_id       String
  provider_id           String
  event_type            SubscriptionEventType
  plan_from             PlanType?
  plan_to               PlanType
  amount_charged        Decimal?              @db.Decimal(12, 2)
  wallet_transaction_id String?               @unique
  created_at            DateTime              @default(now())

  // Relations
  subscription       Subscription       @relation(fields: [subscription_id], references: [id])
  provider           ProviderProfile    @relation(fields: [provider_id], references: [id])
  wallet_transaction WalletTransaction? @relation(fields: [wallet_transaction_id], references: [id])

  @@index([subscription_id])
  @@index([provider_id])
  @@map("subscription_history")
}

// ─────────────────────────────────────────────────────────
// 16. NOTIFICATION
// In-app notifications for all platform events.
// ─────────────────────────────────────────────────────────

model Notification {
  id         String           @id @default(uuid())
  user_id    String
  type       NotificationType
  title      String
  message    String
  is_read    Boolean          @default(false)
  metadata   Json?
  created_at DateTime         @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([user_id, is_read])
  @@index([created_at])
  @@map("notifications")
}

// ─────────────────────────────────────────────────────────
// 17. ADMIN_LOG
// Immutable audit trail of all admin actions.
// ─────────────────────────────────────────────────────────

model AdminLog {
  id          String          @id @default(uuid())
  admin_id    String
  action_type AdminActionType
  target_type String
  target_id   String
  details     Json?
  created_at  DateTime        @default(now())

  // Relations
  admin User @relation("AdminActions", fields: [admin_id], references: [id])

  @@index([admin_id])
  @@index([action_type, created_at])
  @@index([target_type, target_id])
  @@map("admin_logs")
}

// ─────────────────────────────────────────────────────────
// 18. SUPPORT_TICKET
// User support tickets and help requests.
// ─────────────────────────────────────────────────────────

model SupportTicket {
  id          String         @id @default(uuid())
  user_id     String
  subject     String
  message     String
  status      TicketStatus   @default(open)
  priority    TicketPriority @default(medium)
  assigned_to String?
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt

  // Relations
  user     User          @relation("UserTickets", fields: [user_id], references: [id], onDelete: Cascade)
  assignee User?         @relation("AssignedTickets", fields: [assigned_to], references: [id])
  replies  TicketReply[]

  @@index([user_id])
  @@index([status])
  @@index([assigned_to])
  @@map("support_tickets")
}

// ─────────────────────────────────────────────────────────
// 19. TICKET_REPLY
// Replies to support tickets from users or admins.
// ─────────────────────────────────────────────────────────

model TicketReply {
  id         String   @id @default(uuid())
  ticket_id  String
  user_id    String
  message    String
  is_admin   Boolean  @default(false)
  created_at DateTime @default(now())

  // Relations
  ticket SupportTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([ticket_id])
  @@map("ticket_replies")
}

// ─────────────────────────────────────────────────────────
// 20. PLATFORM_SETTING
// Global platform configuration settings.
// ─────────────────────────────────────────────────────────

model PlatformSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  updated_by  String?
  updated_at  DateTime @updatedAt
  created_at  DateTime @default(now())

  // Relations
  updater User? @relation(fields: [updated_by], references: [id])

  @@map("platform_settings")
}

// ─────────────────────────────────────────────────────────
// 21. BROADCAST_MESSAGE
// Admin broadcast messages to users.
// ─────────────────────────────────────────────────────────

model BroadcastMessage {
  id          String   @id @default(uuid())
  title       String
  message     String
  target_role String
  sent_count  Int      @default(0)
  sent_by     String
  created_at  DateTime @default(now())

  // Relations
  sender User @relation(fields: [sent_by], references: [id])

  @@index([created_at])
  @@map("broadcast_messages")
}
